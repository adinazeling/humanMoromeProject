---
title: "Conditional PMR Code"
author: "Adina Zhang"
date: "June 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r}
# Load datasets
mort65plus = read_csv("./mort17_65plus.csv")
icd10_df = read_csv("icd10_hierarchy.csv")

set.seed(1)

# Simplify to a test dataset
sample_df = mort65plus %>% 
  sample_n(5000) %>% 
  select(X1, icd10, ra2:ra20) %>% 
  rename(id = X1)

# Filter out underlying causes of death == W00-W19 (falls)
sample_fall = sample_df %>% 
  filter(grepl("W", icd10)) %>%
  mutate(number = str_sub(icd10, 2, 3)) %>% 
  filter(number <= 19) %>% select(-number) %>%
  gather(key = ra_position, value = ra_value, ra2:ra20) %>% 
  filter(!str_detect(ra_value, "^S"),
         !str_detect(ra_value, "^T0"),
         !str_detect(ra_value, "^T1")) %>% 
  na.omit()

```

```{r}
# Count observed number of pairs among falls
# Count icd10 occurrence among falls
fall1 = sample_fall %>%
  select(-icd10, -ra_position) %>% 
  mutate(n = 1) %>%
  spread(ra_value, n, fill = 0) 

# Transpose matrix and count pairs
fall_comb = sample_fall %>% 
  pull(ra_value) %>% 
  unique() %>% 
  combn(2) %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(obs = map2_int(V1, V2, 
                         ~sum(apply(fall1 %>% select(.x, .y), 1, sum) == 2))) %>% 
  arrange(desc(obs))
```

```{r}
# Count pairs of icd10 codes among all 65+ adults
sample_tidy = sample_df %>% 
  gather(key = ra_position, value = ra_value, ra2:ra20) %>% 
  na.omit()

sample1 = sample_tidy %>% 
  select(-icd10, -ra_position) %>% 
  mutate(n = 1) %>% 
  # Filter out any duplicate data for the same person (one person had K729 
  # entered twice)
  distinct(id, ra_value, n) %>% 
  spread(ra_value, n, fill = 0)

sample_comb = sample_tidy %>% 
  pull(ra_value) %>% 
  unique() %>% 
  combn(2) %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(n = map2_int(V1, V2, 
                         ~sum(apply(sample1 %>% select(.x, .y), 1, sum) == 2))) 

full_join(fall_comb, sample_comb, by = c("V1", "V2"))
  
```

